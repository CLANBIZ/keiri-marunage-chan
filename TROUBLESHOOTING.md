# トラブルシューティング集（AIエージェント向け）

> **このドキュメントの目的**
>
> 様々な環境・スキルレベルのユーザーが遭遇する問題に、AIエージェントが適切に対応するためのガイド。
> ユーザーを責めず、寄り添って解決すること。

**バージョン**: 1.3.1
**最終更新**: 2025-12-04

---

## 目次

1. [セットアップ編](#1-セットアップ編)
2. [freee API編](#2-freee-api編)
3. [銀行CSV編](#3-銀行csv編)
4. [ファイルアップロード編](#4-ファイルアップロード編)
5. [税務チェック編](#5-税務チェック編)
6. [環境依存編](#6-環境依存編)

---

## 1. セットアップ編

### 1.1 Pythonがインストールされていない

**症状:**
```
'python' は、内部コマンドまたは外部コマンド...として認識されていません
```

**対応:**
```
ユーザーに確認: 「Pythonはインストールされていますか？」

インストールされていない場合:
1. https://www.python.org/downloads/ からダウンロードを案内
2. インストール時に「Add Python to PATH」にチェックを入れるよう伝える
3. インストール後、ターミナルを再起動してもらう
```

**補足ウェブサーチ:**
```
「Python インストール Windows 初心者」で検索し、
画像付きのわかりやすいガイドを案内
```

---

### 1.2 pip install が失敗する

**症状:**
```
ERROR: Could not install packages due to an OSError
Permission denied
```

**対応:**
```python
# Windows の場合
pip install --user -r requirements.txt

# それでもダメなら
python -m pip install --user -r requirements.txt

# 管理者権限が必要な場合（最終手段）
# 「管理者として実行」でターミナルを開いてもらう
```

**ネットワークエラーの場合:**
```
ユーザーに確認: 「社内ネットワークやプロキシ環境ですか？」

プロキシ環境の場合:
pip install --proxy http://proxy.example.com:8080 -r requirements.txt
```

---

### 1.3 server.py が起動しない

**症状A: ポートが使用中**
```
OSError: [Errno 48] Address already in use
```

**対応:**
```python
# 別のポートで起動
python server.py  # デフォルトは5000

# 環境変数でポート変更
PORT=5001 python server.py  # Mac/Linux
set PORT=5001 && python server.py  # Windows
```

**症状B: モジュールが見つからない**
```
ModuleNotFoundError: No module named 'flask'
```

**対応:**
```
pip install -r requirements.txt を再実行
```

---

### 1.4 ブラウザで http://localhost:5000 が開けない

**症状A: 「localhost へのアクセスが拒否されました」**

```
原因: ブラウザ（特にChrome）が自動的に https:// に変換している
      → サーバーはHTTPのみ対応のため、HTTPSではアクセス不可
```

**対応:**
```
明示的に http:// を付けてアクセス：
→ http://localhost:5000
→ http://127.0.0.1:5000

それでもダメな場合:
→ シークレットモード / プライベートウィンドウで試す
→ 別のブラウザ（Firefox, Safari, Edge）で試す
```

**症状B: ページが表示されない**

**対応:**
```
1. server.py が起動しているか確認
   → 「バーチャル税務調査～経理丸投げちゃん～」と表示されているか？

2. URLを確認
   → http://localhost:5000 （httpsではない）
   → http://127.0.0.1:5000 も試す

3. ファイアウォール確認
   → 一時的に無効化して試す（セキュリティソフトも）

4. 別のブラウザで試す
   → Chrome, Firefox, Edge など
```

---

## 2. freee API編

### 2.1 freeeアカウントを持っていない

**対応:**
```
ユーザーに確認: 「freee会計のアカウントはお持ちですか？」

持っていない場合:
「このツールはfreee会計のデータを読み取るツールです。
 まずfreee会計のアカウント作成が必要です。
 https://www.freee.co.jp/ から登録できます。
 無料プランではAPIが使えないため、有料プランが必要です。」
```

---

### 2.2 freeeの無料プランを使っている

**対応:**
```
ユーザーに確認: 「freee会計のプランは何ですか？」

無料プランの場合:
「申し訳ありませんが、freee APIは有料プランでのみ利用可能です。
 ミニマムプラン以上へのアップグレードをご検討ください。」
```

---

### 2.3 アクセストークンの取得方法がわからない

**対応:**
```
初回の場合:
1. https://app.secure.freee.co.jp/developers/start_guides/new_company にアクセス
2. 画面の指示に従って事業所を選択
3. 表示されたアクセストークンをコピー

2回目以降の場合:
1. freeeから届いているメールを検索（件名に「アクセストークン」など）
2. メール内の「アクセストークン取得ページへ」リンクをクリック
3. 新しいトークンをコピー
```

**補足ウェブサーチ:**
```
「freee API アクセストークン 取得方法 2025」で検索し、
最新の公式ガイドまたは画像付き解説を案内
```

---

### 2.4 「テスト事業所」と「本番事業所」の違いがわからない

**対応:**
```
ユーザーに確認: 「freeeで複数の事業所が表示されていますか？」

複数ある場合:
「テスト事業所」はサンプルデータ用です。
実際の会計データは「本番用」または会社名が入った事業所を選んでください。

判断基準:
- 「テスト」「開発」「サンプル」が名前に含まれる → テスト用
- 会社名や屋号が入っている → 本番用
```

---

### 2.5 トークンを入力したが接続できない

**対応フロー:**
```python
# まずcompanies APIで診断
res = requests.get("https://api.freee.co.jp/api/1/companies",
                   headers={"Authorization": f"Bearer {token}"})

if res.status_code == 401:
    # トークンが無効
    print("トークンが期限切れか無効です。再取得してください。")

elif res.status_code == 200:
    companies = res.json()['companies']
    if len(companies) == 0:
        print("このトークンに紐づく事業所がありません。")
    else:
        print(f"接続成功。事業所: {[c['name'] for c in companies]}")
```

---

## 3. 銀行CSV編

### 3.1 銀行CSVのエクスポート方法がわからない

**対応:**
```
ユーザーに確認: 「どの銀行をお使いですか？」

銀行名を聞いたら:
「{銀行名} 入出金明細 CSV ダウンロード」でウェブサーチし、
公式のガイドを案内する。

よくある銀行の例:
- 三菱UFJ銀行: BizSTATION → 入出金明細 → CSVダウンロード
- 三井住友銀行: Web21 → 明細照会 → CSV出力
- みずほ銀行: みずほe-ビジネスサイト → 入出金明細 → ダウンロード
- 楽天銀行: 入出金明細 → CSV形式でダウンロード
- 住信SBIネット銀行: 入出金明細 → CSVダウンロード
```

**補足ウェブサーチ:**
```
「{銀行名} ネットバンキング CSV エクスポート 方法」で検索
```

---

### 3.2 CSVではなくPDFやExcelで出力してきた

**対応:**
```
ユーザーに説明:
「申し訳ありませんが、現在このツールはCSV形式のみ対応しています。
 ネットバンキングからCSV形式でダウンロードし直していただけますか？」

PDFしか出力できない銀行の場合:
「お使いの銀行ではCSV出力に対応していない可能性があります。
 以下の方法を試してみてください:
 1. Excel等でPDFから手動でCSVを作成
 2. PDFからCSVに変換するオンラインツールを使用
    （ただし機密データなので信頼できるツールのみ推奨）」

将来対応を約束:
「PDF対応は今後の改善予定です。」
```

**Excelの場合:**
```
「Excelファイルの場合は、CSVとして保存し直してください:
 ファイル → 名前を付けて保存 → ファイルの種類を「CSV UTF-8」に変更」
```

---

### 3.3 CSVの文字化け

**症状:**
```
æ–¥ä»˜ や ‚¨‚è‚Ä などの文字化け
```

**対応:**
```python
# エンコーディングを変えて読み込み
import pandas as pd

# まずShift-JISを試す（日本の銀行CSVはこれが多い）
try:
    df = pd.read_csv('bank.csv', encoding='shift_jis')
except:
    # ダメならCP932
    try:
        df = pd.read_csv('bank.csv', encoding='cp932')
    except:
        # それでもダメならUTF-8
        df = pd.read_csv('bank.csv', encoding='utf-8')
```

**ユーザーへの説明:**
```
「文字化けが発生しています。CSVを保存し直す際に、
 エンコーディングを「UTF-8」に設定してみてください。」
```

---

### 3.4 CSVのフォーマットが認識されない

**症状:**
```
日付や金額の列が正しく認識されない
```

**対応:**
```
ユーザーに確認: 「CSVの最初の数行を見せてもらえますか？」

CSVの内容を確認し:
1. ヘッダー行があるか確認
2. 日付形式を確認（YYYY/MM/DD, YYYY-MM-DD, MM/DD/YYYY など）
3. 金額形式を確認（カンマあり/なし、円マークあり/なし）

対応:
- bank_parser.pyが対応していないフォーマットの場合、
  ユーザーにExcelで開いて標準形式に整形してもらう
```

---

## 4. ファイルアップロード編

### 4.1 ファイルが大きすぎる

**症状:**
```
アップロードがタイムアウトする
ブラウザがフリーズする
```

**対応:**
```
ユーザーに確認: 「アップロードしようとしているファイルのサイズはどれくらいですか？」

大きすぎる場合（目安: 1ファイル50MB以上、合計200MB以上）:
「ファイルが大きすぎるようです。以下の方法をお試しください:

1. PDFの場合: 圧縮ツールでサイズを縮小
2. 画像の場合: 解像度を下げる
3. 複数ファイルの場合: 何回かに分けてアップロード

税務チェックに必要な主要書類を優先してアップロードしてください:
- 議事録
- 規程類
- 契約書
（領収書の画像などは後回しでOK）」
```

---

### 4.2 ファイル数が多すぎる

**症状:**
```
何百、何千ものファイルをアップロードしようとしている
```

**対応:**
```
ユーザーに確認: 「何件くらいのファイルをアップロードしようとしていますか？」

多すぎる場合（目安: 100件以上）:
「ファイル数が多いですね。処理に時間がかかる可能性があります。

まずは以下の重要書類を優先してください:
1. 役員報酬関連（議事録、規程）
2. 契約書
3. 規程類（旅費規程、社宅規程など）

領収書や請求書は、高額なもの（50万円以上）のみで十分です。」
```

---

### 4.3 ZIPファイルが展開できない

**症状:**
```
ZIPをアップロードしたが中身が認識されない
```

**対応:**
```
1. ZIPファイルが壊れていないか確認
   → ローカルで展開できるか試してもらう

2. パスワード付きZIPの場合
   → パスワードを解除してから再アップロード

3. 特殊な圧縮形式の場合（RAR, 7zなど）
   → ZIPに変換してもらう
```

---

### 4.4 日本語ファイル名が文字化け

**症状:**
```
アップロード後にファイル名が「?????」になる
```

**対応:**
```
「日本語ファイル名が文字化けすることがあります。
 ファイル名を英数字に変更してから再アップロードしてみてください。

 例:
 変更前: 臨時株主総会議事録.pdf
 変更後: rinji_soukai_gijiroku.pdf

 ファイルの中身は日本語のままで大丈夫です。」
```

---

### 4.5 アップロードしたのにファイルが認識されない

**症状:**
```
UIにファイルが表示されるが、サーバーに保存されていない
curl http://localhost:5000/api/files で確認すると空
```

**確認手順（AI向け）:**
```
ユーザーが「アップロードした」と言ったら:

1. 「ブラウザの開発者ツール（F12）→ Consoleタブにエラーは出ていますか？」と確認

2. 「Content Security Policy」エラーがある場合:
   → ブラウザ拡張機能（広告ブロッカー等）を一時無効化
   → シークレットモードで試す
   → 別のブラウザ（Chrome/Firefox/Edge）で試す

3. ネットワークエラーの場合:
   → server.py が起動しているか確認
   → ポート5000が他のアプリに使われていないか確認
```

**対応:**
```
「ブラウザの開発者ツール（F12キー）を開いて、Consoleタブに
赤いエラーメッセージが出ていないか確認してもらえますか？」
```

---

## 5. 税務チェック編

### 5.1 取引データが0件

**対応フロー:**
```
1. 日付範囲を確認
   → start_date と end_date が正しいか？
   → 決算期間に合っているか？

2. 事業所を確認
   → テスト事業所を選んでいないか？
   → 本番事業所に取引データがあるか？

3. freee側を確認
   → freeeにログインして取引が登録されているか確認してもらう
```

---

### 5.2 税区分エラーが大量に出る

**対応:**
```
ユーザーに説明:
「税区分エラーが多数検出されましたが、これはfreeeの自動設定によるものが多いです。
 パニックにならなくて大丈夫です。

 まず5件ほどサンプルを確認して、修正が必要か判断しましょう。
 必要であれば一括修正も可能です。」
```

---

### 5.3 法人資料（議事録など）がない

**対応:**
```
ユーザーに確認:
「以下の書類はお持ちですか？

□ 臨時株主総会議事録（役員報酬改定時）
□ 役員報酬規程
□ 旅費規程
□ 業務委託契約書

お持ちでない場合も税務チェックは実行できますが、
一部の項目は「要確認」となります。

必要に応じて、後から作成することをお勧めします。」
```

---

### 5.4 _INDEX.jsonがない・壊れている

**対応:**
```
_INDEX.jsonは法人資料フォルダにある会社情報ファイルです。

ない場合:
→ 法人資料のアップロード時に自動生成されるはず
→ 再アップロードを試す

壊れている場合:
→ JSONの構文エラーを修正
→ または削除して再アップロード
```

---

## 6. 環境依存編

### 6.1 Windows特有の問題

**ブラウザを開くコマンド（AI向け）:**
```bash
# ✅ 正しいコマンド
start http://localhost:5000

# ❌ これはエラーになる（Exit code 1）
explorer.exe "http://localhost:5000"
```

**パス区切り文字:**
```python
# Windowsは \ を使うが、Pythonでは / も使える
# パス文字列ではraw文字列かスラッシュを使う
path = r"C:\Users\name\Desktop\file.csv"  # raw文字列
path = "C:/Users/name/Desktop/file.csv"   # スラッシュ
```

**文字コード:**
```python
# Windowsのデフォルトはcp932、UTF-8を明示する
python -X utf8 server.py
```

**コンソールの日本語文字化け:**
```
サーバー起動時に「�o�[�`...」のような文字化けが表示されても、
サーバー自体は正常に動作している。見た目だけの問題なので無視してよい。
```

**PowerShell vs コマンドプロンプト:**
```
PowerShellで動かない場合はコマンドプロンプトを試す
（またはその逆）
```

---

### 6.2 Mac特有の問題

**Pythonバージョン:**
```
Mac標準のPythonは古い場合がある
python3 コマンドを使う

python3 server.py
pip3 install -r requirements.txt
```

**externally-managed-environment エラー（macOS Sonoma以降 + Homebrew）:**

```
× This environment is externally managed
╰─> To install Python packages system-wide, try brew install...
```

**原因:** PEP 668 により、システムPythonへの直接パッケージインストールがブロックされています。

**対応:** 仮想環境（venv）を作成して実行：
```bash
cd keiri-marunage-chan
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
python server.py
```

**補足:**
- 仮想環境を有効化すると、プロンプトに `(venv)` が表示されます
- 次回以降は `source venv/bin/activate` で有効化してから `python server.py` を実行
- 仮想環境を終了するときは `deactivate` コマンド

**権限問題（非推奨）:**
```
# venvを使えない特殊な環境の場合のみ
pip3 install --user -r requirements.txt
# または（非推奨・システム破損リスクあり）
pip3 install --break-system-packages -r requirements.txt
```

---

### 6.3 Linux特有の問題

**ヘッドレス環境:**
```
サーバー環境でブラウザがない場合:
→ ローカルPCからSSHポートフォワーディング
ssh -L 5000:localhost:5000 user@server
→ ローカルのブラウザで http://localhost:5000 にアクセス
```

---

### 6.4 セキュリティソフトがブロック

**症状:**
```
サーバーが起動するがブラウザから接続できない
ウイルス対策ソフトの警告が出る
```

**対応:**
```
「セキュリティソフトがローカルサーバーをブロックしている可能性があります。

1. セキュリティソフトの設定でlocalhostの通信を許可
2. 一時的にセキュリティソフトを無効化して試す
   （作業後は必ず有効に戻す）
3. ファイアウォールの設定を確認

server.pyはローカルホスト（127.0.0.1）のみでリッスンするので、
外部からのアクセスはありません。安全です。」
```

---

## 7. AIエージェントとしての心構え

### 7.1 ユーザーを責めない

```
❌ 「CSVではなくPDFを出したのが間違いです」
✅ 「PDFでお持ちなんですね。現在はCSV対応のみですが、お手数ですがCSVで出力し直していただけますか？」

❌ 「なぜそんな大量のファイルをアップロードしようとしたのですか」
✅ 「たくさんの書類をご準備いただいたんですね。処理効率化のため、まず重要書類から始めましょう」
```

### 7.2 わからないときはウェブサーチ

```
ユーザーの環境や銀行が特殊で対応方法がわからない場合:
→ 「{銀行名/ソフト名} {やりたいこと} 方法」でウェブサーチ
→ 公式ドキュメントまたは信頼できるブログ記事を案内
```

### 7.3 対応できない場合は正直に

```
「申し訳ありませんが、現在このツールでは対応していない機能です。
 将来のアップデートで対応予定ですが、現時点では以下の代替案をお試しください...」
```

### 7.4 セキュリティ意識を持つ

```
- ユーザーにパスワードやトークンをチャットに貼り付けさせない
- 機密ファイルを外部サービスにアップロードさせない
- 不審なURLやツールを案内しない
```

---

*このドキュメントはAIエージェント向けです。ユーザー向け情報はREADME.mdを参照してください。*

---

### フォーク時のお願い

改変・再配布する場合は、以下のクレジット表記を記載してください：

```
Original work: バーチャル税務調査～経理丸投げちゃん～
https://github.com/CLANBIZ/keiri-marunage-chan
Copyright (c) 2025 株式会社CLAN (https://clanbiz.net/keiri-marunage-chan-LP/)
```
